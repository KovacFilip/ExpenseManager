@page "/login"
@using Helper.Helpers;
@using Helper.ObjectsToApi;
@using System.Text.Json;
@inject IJSRuntime JSRuntime
@using DB.models;
@inject HttpClient HttpClient;

<div class="container">
    <h1>Login</h1>

    <div class="item">
        <label>Username: </label>
        <input type="text" @bind="usernameValue">
    </div>

    <div class="item">
        <label>Password: </label>
        <input type="password" @bind="passwordValue">
    </div>
    <Button ButtonText="Login" onClick="@HandleClick"></Button>
</div>

@code {
    private readonly HttpClient httpClient = new HttpClient { BaseAddress = new Uri("http://localhost:5000") };
    private string usernameValue = "";
    private string passwordValue = "";

    private async void HandleClick(MouseEventArgs args)
    {
        var login = new LoginObject();

        login.Username = usernameValue;

        string passwordHash = HelperFunctions.HashPassword(passwordValue);
        login.PasswordHash = passwordHash;

        var response = await httpClient.PostAsync("/api/login", new StringContent(JsonSerializer.Serialize(login)));

        if ((int)response.StatusCode == 200) {

            string res = await response.Content.ReadAsStringAsync();
            Person? person = JsonSerializer.Deserialize<Person>(res);

            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "id", person!.Id);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "name", person!.Username);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "role", person!.Role);
        }
    }

}
